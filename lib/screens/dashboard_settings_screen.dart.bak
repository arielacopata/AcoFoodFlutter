import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:convert';
import '../models/dashboard_preferences.dart';

class DashboardSettingsScreen extends StatefulWidget {
  final DashboardPreferences currentPreferences;

  const DashboardSettingsScreen({
    super.key,
    required this.currentPreferences,
  });

  @override
  State<DashboardSettingsScreen> createState() =>
      _DashboardSettingsScreenState();
}

class _DashboardSettingsScreenState extends State<DashboardSettingsScreen> {
  late DashboardPreferences _preferences;

  @override
  void initState() {
    super.initState();
    _preferences = widget.currentPreferences;
  }

  Future<void> _savePreferences() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(
      'dashboard_preferences',
      jsonEncode(_preferences.toJson()),
    );
    if (mounted) {
      Navigator.pop(context, _preferences);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Ajustes del Dashboard'),
        actions: [
          IconButton(
            icon: const Icon(Icons.check),
            tooltip: 'Guardar',
            onPressed: _savePreferences,
          ),
        ],
      ),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Secci贸n: Mostrar en Dashboard
          const Text(
            'Mostrar en Dashboard',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 8),          Card(
            child: Column(
              children: [
                SwitchListTile(
                  title: const Text('Promedio Diario'),
                  subtitle: const Text('Tarjeta con caloras y macronutrientes'),
                  value: _preferences.showMacrosCard,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(showMacrosCard: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Grfico de Tendencias'),
                  subtitle: const Text('Grfico de lnea con caloras/macros'),
                  value: _preferences.showCaloriesChart,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(showCaloriesChart: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Distribucin de Macronutrientes'),
                  subtitle: const Text('Grfico de distribucin porcentual'),
                  value: _preferences.showMacrosPercentChart,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(showMacrosPercentChart: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Top 5 Alimentos'),
                  subtitle: const Text('Alimentos ms consumidos'),
                  value: _preferences.showTopFoods,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(showTopFoods: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Hbitos Completados'),
                  subtitle: const Text('Estadsticas de hbitos'),
                  value: _preferences.showHabitsCompletion,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(showHabitsCompletion: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Anlisis de Nutrientes'),
                  subtitle: const Text('Evolucin y cumplimiento de RDA/AI'),
                  value: _preferences.showNutrientsAnalysis,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(showNutrientsAnalysis: value);
                    });
                  },
                ),
              ],
            ),
          ),
          const SizedBox(height: 24),

          // Secci贸n: Incluir en PDF
          const Text(
            'Incluir en Exportaci贸n PDF',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 8),          Card(
            child: Column(
              children: [
                SwitchListTile(
                  title: const Text('Promedio Diario'),
                  subtitle: const Text('Resumen de caloras y macronutrientes'),
                  value: _preferences.exportMacrosCard,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(exportMacrosCard: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Distribucin Porcentual Macros'),
                  subtitle: const Text('Grfico de distribucin porcentual'),
                  value: _preferences.exportMacrosPercentChart,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(exportMacrosPercentChart: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Datos Diarios'),
                  subtitle: const Text('Tabla con datos da por da'),
                  value: _preferences.exportDailyData,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(exportDailyData: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Top 5 Alimentos'),
                  subtitle: const Text('Lista de alimentos ms consumidos'),
                  value: _preferences.exportTopFoods,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(exportTopFoods: value);
                    });
                  },
                ),
                const Divider(height: 1),
                SwitchListTile(
                  title: const Text('Hbitos Completados'),
                  subtitle: const Text('Estadsticas de cumplimiento de hbitos'),
                  value: _preferences.exportHabitsCompletion,
                  onChanged: (value) {
                    setState(() {
                      _preferences = _preferences.copyWith(exportHabitsCompletion: value);
                    });
                  },
                ),
              ],
            ),
          ),
          const SizedBox(height: 24),

          // Bot贸n de restaurar valores predeterminados
          OutlinedButton.icon(
            onPressed: () {
              setState(() {
                _preferences = const DashboardPreferences();
              });
            },
            icon: const Icon(Icons.restore),
            label: const Text('Restaurar valores predeterminados'),
          ),
        ],
      ),
    );
  }
}